<script>
  import { afterNavigate } from '$app/navigation';

  import { setSearchParams, getSearchParams, treeFlatten, diff } from '$/utils';
  import TableRow from '@c/TableRow.svelte';
  import Pagination from '@c/Pagination.svelte';

  export let limit;

  export let rootPathname;
  export let page = 1;
  export let query = null;
  afterNavigate(navigation => {
    const searchParams = getSearchParams(['p', 'q']); // page, query
    if (searchParams.p != null) page = searchParams.p;
    if (searchParams.q != null) query = searchParams.q;
    setSearchParams({ p: page, q: query }, navigation, rootPathname);
  });
  $: setSearchParams({ p: page, q: query });

  $: if (limit != null && page == null) {
    // reset page on limit change
    page = 1;
  }

  export let collection = null;
  export let items;
  export let itemsCount = null;
  export let head;
  export let mapper;

  $: hierarchy = items.some(item => item.children); // has children
  export let order = false;
  let expandedItems = [];

  $: itemsFlat = hierarchy ? treeFlatten(items) : items;
  $: maxDepth = hierarchy ? itemsFlat.reduce((max, item) => Math.max(max, item._meta.path.length), 0) - 1 : 0;

  const smallestCellWidth = 2.25;
  const hierarchyCellWidth = smallestCellWidth * 0.8;

  function getWidths(head, hierarchy, order, maxDepth) {
    let widths = [];
    if (order) widths.push(smallestCellWidth + 'rem');
    if (hierarchy) widths.push(hierarchyCellWidth * (maxDepth + 1) + 'rem');
    widths.push(
      ...head.map(h => {
        if (h.width) widths.push(h.width);
        if (h.checkbox) return smallestCellWidth + 'rem';
        if (h.id) return '4rem';
        if (h.blame) return 'minmax(20ch, 1fr)';
        return 'minmax(15ch, 1fr)';
      })
    );
    return widths.join(' ');
  }

  let showDropzonesItemID = null; // id
  function drop() {
    showDropzonesItemID = null;
  }
  function dragend() {
    showDropzonesItemID = null;
  }
  function dragenter(e) {
    showDropzonesItemID = e.detail.id;
  }

  $: widths = getWidths(head, hierarchy, order, maxDepth);
</script>

<div class="table-wrapper">
  <div class="table">
    <TableRow headRow {head} {hierarchy} {order} {maxDepth} {widths} {collection} />
    {#if items.length}
      {#each items as item (item)}
        <TableRow
          bind:items
          bind:expandedItems
          {head}
          {hierarchy}
          {order}
          {maxDepth}
          {widths}
          bind:item
          {mapper}
          {collection}
          {showDropzonesItemID}
          on:drop={drop}
          on:dragend={dragend}
          on:dragenterItem={dragenter}
        />
      {/each}
    {:else}
      <div class="empty">Brak element√≥w o podanych parametrach</div>
    {/if}
  </div>
</div>

{#if !hierarchy && limit != -1}
  <Pagination bind:limit bind:page total={itemsCount} />
{/if}

<style>
  .table-wrapper {
    overflow-x: auto;
    border-radius: var(--border-radius);
    border: var(--border-light);
  }
  .table {
    overflow-x: auto;
  }

  .empty {
    padding: 1rem;
    width: 100%;
    background-color: var(--accent-white);
  }
</style>
